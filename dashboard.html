<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard (Debug) â€” Intent FreeDomain</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script>
  // Backend base - keep this pointed to your Render service
  const API_BASE = 'https://backend-render-gehg.onrender.com';
  function api(p){ return API_BASE + p; }
</script>

<style>
:root{--bg:#071226;--muted:#94a3b8;--accent:#06b6d4;--accent2:#3b82f6;--text:#e6eef6}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#071a2a);color:var(--muted)}
header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{display:flex;gap:12px;align-items:center}
.logo-wrap{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center}
.main{max-width:1100px;margin:22px auto;padding:0 18px 60px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
.h1{color:var(--text);font-weight:800;font-size:24px;margin:0 0 12px}
.input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#022;cursor:pointer;font-weight:800}
.debug{background:#04131a;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;color:#9fe7f6;font-family:monospace;white-space:pre-wrap;max-height:420px;overflow:auto}
.label{font-weight:700;color:var(--text);margin-bottom:8px;display:block}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.error{color:#ffb3b3}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo-wrap" aria-hidden="true"></div>
    <div style="line-height:1">
      <div style="font-weight:800;color:var(--text)">Intent Dashboard (Debug)</div>
      <div class="small">This debug page shows raw API responses</div>
    </div>
  </div>
  <nav><a href="/register.html" class="small">Register</a></nav>
</header>

<main class="main">
  <section class="panel">
    <div class="h1">Account</div>
    <pre id="account" class="debug">Not loaded</pre>
  </section>

  <section class="panel">
    <div class="h1">Subdomains</div>
    <pre id="subs" class="debug">Not loaded</pre>
  </section>

  <section class="panel">
    <div class="h1">Create / Test</div>
    <div class="row" style="margin-bottom:8px">
      <input id="subname" class="input" placeholder="subdomain (example)" />
      <input id="target" class="input" placeholder="CNAME targets (pipe | separated) or IP" style="min-width:300px" />
      <input id="ns" class="input" placeholder="Nameservers (optional pipe separated)" style="min-width:260px" />
      <button id="create" class="btn">Create</button>
    </div>
    <div style="margin-top:12px" class="small">Status & debug output for the create request appears below:</div>
    <pre id="createDebug" class="debug">Idle</pre>
  </section>

  <section class="panel">
    <div class="h1">HTTP Debug Log</div>
    <div class="small">This shows the last request/response details (status, headers, body) for the two requests the page makes.</div>
    <pre id="httpDebug" class="debug">No requests yet</pre>
  </section>
</main>

<script>
  // Utility to pretty-print headers
  function headersToObj(headers) {
    const obj = {};
    for (let pair of headers.entries()) obj[pair[0]] = pair[1];
    return obj;
  }

  async function fetchAndDebug(url, opts = {}) {
    const out = { url, method: opts.method || 'GET', request: { headers: opts.headers || {}, body: opts.body || null } };
    try {
      const res = await fetch(url, opts);
      out.response = { status: res.status, statusText: res.statusText, headers: headersToObj(res.headers) };
      const text = await res.text();
      // try json parse
      try { out.response.body = JSON.parse(text); }
      catch(e){ out.response.body = text; }
      return out;
    } catch (err) {
      out.error = String(err);
      return out;
    }
  }

  function dump(obj){
    return JSON.stringify(obj, null, 2);
  }

  async function loadAll() {
    const token = localStorage.getItem('intent_token');
    const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
    // /api/dashboard
    document.getElementById('account').textContent = 'Loading...';
    const dash = await fetchAndDebug(api('/api/dashboard'), { headers });
    document.getElementById('httpDebug').textContent = dump(dash);
    if (dash.response && (dash.response.status === 200)) {
      document.getElementById('account').textContent = dump(dash.response.body);
    } else {
      const msg = dash.error || (dash.response && (dash.response.body || dash.response.statusText)) || 'unknown';
      document.getElementById('account').textContent = 'ERROR: ' + String(msg);
    }

    // /api/subdomains
    document.getElementById('subs').textContent = 'Loading...';
    const subs = await fetchAndDebug(api('/api/subdomains'), { headers });
    // Append to the HTTP debug the subs result too
    document.getElementById('httpDebug').textContent = dump({ dashboard: dash, subdomains: subs });
    if (subs.response && (subs.response.status === 200)) {
      document.getElementById('subs').textContent = dump(subs.response.body);
    } else {
      const msg = subs.error || (subs.response && (subs.response.body || subs.response.statusText)) || 'unknown';
      document.getElementById('subs').textContent = 'ERROR: ' + String(msg);
    }
  }

  document.getElementById('create').addEventListener('click', async () => {
    document.getElementById('createDebug').textContent = 'Sending...';
    const name = document.getElementById('subname').value.trim();
    const target = document.getElementById('target').value.trim();
    const ns = document.getElementById('ns').value.trim();
    const token = localStorage.getItem('intent_token');
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers['Authorization'] = 'Bearer ' + token;

    if (!name) { document.getElementById('createDebug').textContent = 'Enter a name first'; return; }

    const payload = JSON.stringify({ name, target, ns });
    const debug = await fetchAndDebug(api('/api/subdomains'), { method: 'POST', headers, body: payload });
    document.getElementById('createDebug').textContent = dump(debug);
    // Refresh lists after create attempt
    setTimeout(loadAll, 800);
  });

  // Initial load
  loadAll();
</script>
</body>
</html>
